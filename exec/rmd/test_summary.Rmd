---
title: "Conditional Text Testing"
author: "Matthew Van Scoyoc"
date: "`r format(as.Date(Sys.Date(), format = '%Y-%m-%d'), '%B %d, %Y')`"
output:
  pdf_document:
  fig_caption: yes
latex_engine: xelatex
editor_options:
  chunk_output_type: console
mainfont: Arial
urlcolor: blue
---
\raggedright
```{r Setup, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
#-- Packages
# devtools::install_github("scoyoc/climateAnalyzeR")
library("climateAnalyzeR")

#-- Functions
# Number contraction ---
# Prints the appropriate number contraction for a given number.
number_contraction <- function(x) {
  if (is.na(x)){
    y = FALSE
  } else if (x == 11 | x == 12 | x == 13) {
    y = paste0(x, "th")
  } else if  (x - round(x, -1) == 1) {
    y = paste0(x, "st")
  } else if (x - round(x, -1) == 2) {
    y = paste0(x, "nd")
  } else if (x - round(x, -1) == 3) {
    y = paste0(x, "rd")
  } else {
    y = paste0(x, "th")
  }
  return(y)
}

#-- Load data frame of months.
data(month_df)

#-- Session information (for text)
info <- sessionInfo()
r_ver <- paste(info$R.version$major, info$R.version$minor, sep=".")
```

```{r Data, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
#-- Set desired park unit, water year, and month
# Testing data sets
# Adequate data
# station_id <- "hans_flat_rs"
# station_name <- "Hans Flat Ranger Station"
# my_year <- 2020

station_id <- "canyonlands_theneck"
station_name <- "Island in the Sky Visitor Center"
# my_year <- 2020 # Throws an NA when ranking annual data 
# my_year <- 1973 # Coldest
# my_year <- 1988 # 10th coldest
# my_year <- 2018 # Warmest
# my_year <- 2078 # 10th warmest
# my_year <- 1984 # wettest
# my_year <- 1980 # 10th wettest
# my_year <- 1977 # driest
my_year <- 2000 # 10th driest

# station_id <- "arches"
# station_name <- "Arches Visitor Center"
# my_year <- 2020

# View(annual_dat %>% dplyr::select(year, temp_warmest, prcp_driest))
# 
# (annual_dat %>%
#   dplyr::filter(temp_warmest == 10))$year
# (annual_dat %>%
#   dplyr::filter(temp_coldest == 10))$year
# (annual_dat %>%
#   dplyr::filter(prcp_driest == 10))$year
# (annual_dat %>%
#   dplyr::filter(prcp_wettest == 10))$year

#-- Retreive station metadata
my_station <- stations(my_stations = station_id) %>%
  dplyr::distinct()
yrs_avail <- as.numeric(stringr::str_split(my_station$years_avail,
                                           pattern = ";", simplify = T))
my_station <- my_station %>%
  dplyr::mutate("label" = paste(min(yrs_avail, na.rm = T),
                                max(yrs_avail, na.rm = T), sep = "-"),
                "water_yr" = my_year, 
                "name" = station_name)

#-- 30-year Normals
normals_30yr <- normals(my_stations = station_id) %>%
  tidyr::spread("element", "value")
annual_30yr <- normals_30yr %>%
  dplyr::filter(month == "Annual") %>%
  dplyr::mutate("TEMP_midpt" = ((TMAX - TMIN) / 2) + TMIN)
month_30yr <- normals_30yr %>%
  dplyr::filter(month %in% month.abb) %>%
  dplyr::mutate("month" = month_df$month_name) %>%
  dplyr::rename("month_name" = month,
                "prcp_30yr" = PRCP,
                "tmax_30yr" = TMAX,
                "tmin_30yr" = TMIN) %>%
  dplyr::arrange(month_name) %>%
  dplyr::mutate("prcp_accum_30yr" = cumsum(tidyr::replace_na(prcp_30yr, 0)),
                "temp_midpt_30yr" =((tmax_30yr - tmin_30yr) / 2) + tmin_30yr)

#-- Annual Data
annual_dat  <- import_annual(station_id = station_id,
                             start_year = min(yrs_avail, na.rm = T),
                             end_year = lubridate::year(lubridate::today()),
                             screen_blanks = 'true',
                             remove_missing = TRUE) %>%
  dplyr::select(year | contains("wy")) %>%
  dplyr::mutate("temp_midpt" = ifelse(is.na(tmax_wy) | is.na(tmin_wy), NA,
                                      ((tmax_wy - tmin_wy) / 2) + tmin_wy),
                "prcp_driest" = dplyr::min_rank(prcp_wy),
                "prcp_wettest" = dplyr::min_rank(-prcp_wy),
                "temp_warmest" = dplyr::min_rank(-temp_midpt),
                "temp_coldest" = dplyr::min_rank(temp_midpt),
                "prcp_depart" = prcp_wy - annual_30yr$PRCP,
                "temp_depart" = temp_midpt - annual_30yr$TEMP_midpt,
                "tmax_depart" = tmax_wy - annual_30yr$TMAX,
                "tmin_depart" = tmin_wy - annual_30yr$TMIN)

#-- Monthly Data
# Monthly weather data
mth_dat <- import_monthly(station_id = station_id,
                          start_year = min(yrs_avail, na.rm = T),
                          end_year = lubridate::year(lubridate::today())) %>%
  dplyr::left_join(month_df) %>%
  dplyr::mutate("water_yr" = ifelse(month >= 10, year +1, year)) %>%
  dplyr::arrange(water_yr, water_month) %>%
  dplyr::group_by(water_yr) %>%
  dplyr::mutate("prcp_accum" = cumsum(tidyr::replace_na(prcp, 0))) %>%
  dplyr::mutate("temp_midpt" = ifelse(is.na(tmax) | is.na(tmin), NA,
                                      ((tmax - tmin) / 2) + tmin)) %>%
  dplyr::group_by(water_month) %>%
  dplyr::mutate("prcp_driest" = dplyr::min_rank(prcp),
                "temp_warmest" = dplyr::min_rank(-temp_midpt))

# Monthly departure
mth_depart <- import_departure(station_id = station_id,
                               min(yrs_avail, na.rm = T),
                               end_year = lubridate::year(lubridate::today())) %>%
  dplyr::left_join(month_df) %>%
  dplyr::mutate(water_yr = ifelse(month >= 10, year + 1, year)) %>%
  # filter(water_yr <= my_year) %>%
  dplyr::left_join(dplyr::left_join(mth_dat, month_30yr) %>%
                     dplyr::mutate("prcp_accum_depart" = prcp_accum - 
                                     prcp_accum_30yr) %>%
                     dplyr::ungroup() %>%
                     dplyr::select(water_yr, month_name, prcp_accum_depart))
```

```{r Text_Refs, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
# Consolidate text references
text_refs <- my_station %>%
  dplyr::bind_cols(dplyr::filter(annual_dat, year == my_year)) %>%
  dplyr::mutate("timespan" = max(yrs_avail, na.rm = T) - min(yrs_avail, na.rm = T))

#-- Model annual trends
prcp_lm <- summary(lm(prcp_wy ~ year, data = annual_dat))$coefficients[2, 1]
temp_lm <- summary(lm(temp_midpt ~ year, data = annual_dat))$coefficients[2, 1]

#-- Small subsets for text
tmax_exceed <- dplyr::filter(mth_depart, water_yr == my_year & 
                               tmax_depart > 0)$month_name
tmin_exceed <- dplyr::filter(mth_depart, water_yr == my_year & 
                               tmin_depart > 0)$month_name
prcp_above <- dplyr::filter(mth_depart, water_yr == my_year & 
                              prcp_pctavg > 100)$month_name
prcp_below <- dplyr::filter(mth_depart, water_yr == my_year & 
                              prcp_pctavg < 100)$month_name

# Error evaluation
error_eval <- tibble::tibble(annual_dat[, c("year", "prcp_wy", 
                                            "tmax_wy", "tmin_wy")]) %>%
  dplyr::left_join(mth_dat %>%
                     dplyr::filter(is.na(prcp)) %>% 
                     dplyr::group_by(year) %>%
                     dplyr::count()) %>%
  dplyr::rename("prcp_mth_na" = "n") %>%
  dplyr::left_join(mth_dat %>% 
                     dplyr::filter(is.na(tmax)) %>% 
                     dplyr::group_by(year) %>%
                     dplyr::count()) %>%
  dplyr::rename("tmax_mth_na" = "n") %>%
  dplyr::left_join(mth_dat %>% 
                     dplyr::filter(is.na(tmin)) %>% 
                     dplyr::group_by(year) %>%
                     dplyr::count()) %>%  
  dplyr::rename("tmin_mth_na" = "n") %>%
  dplyr::filter(year == my_year)
  
prcp_error <- tibble::tibble(annual = ifelse(is.na(error_eval$prcp_wy), 
                                             TRUE, FALSE), 
                               month = ifelse(!is.na(error_eval$prcp_mth_na ), 
                                              ifelse(error_eval$prcp_mth_na >2,
                                                     TRUE, FALSE), FALSE))
prcp_error <- if (prcp_error$annual == TRUE & prcp_error$month == TRUE) {
  "both"
  } else if (prcp_error$annual == TRUE & prcp_error$month == FALSE){
    "annual"
    } else if (prcp_error$annual == FALSE & prcp_error$month == TRUE) {
      "month"
      } else ("no error")
  
temp_error <- tibble::tibble(annual = ifelse(is.na(error_eval$tmax_wy) | 
                                               is.na(error_eval$tmin_wy),
                                             TRUE, FALSE), 
                             month = ifelse(!is.na(error_eval$tmax_mth_na) |
                                              !is.na(error_eval$tmin_mth_na),
                                            ifelse(error_eval$tmax_mth_na > 2 |
                                                     error_eval$tmin_mth_na > 2,
                                                   TRUE, FALSE), 
                                            FALSE))
temp_error <- if (temp_error$annual == TRUE & temp_error$month == TRUE) {
  "both"
  } else if (temp_error$annual == TRUE & temp_error$month == FALSE){
    "annual"
    } else if (temp_error$annual == FALSE & temp_error$month == TRUE) {
      "month"
      } else ("no error")

# Evaluate data for conditional text
# Calculate percentiles
prcp_quant <- quantile(annual_dat$prcp_depart, c(0.25, 0.75), na.rm = TRUE)
temp_quant <- quantile(annual_dat$temp_midpt, c(0.25, 0.75), na.rm = TRUE)

# Assign condition
prcp_text <- if (prcp_error %in% c("both", "annual", "month")) {
  "error"
  } else if (text_refs$prcp_depart <= prcp_quant[1]) {
    "dry"
    } else if (text_refs$prcp_depart > prcp_quant[1] & 
               text_refs$prcp_depart < prcp_quant[2]){
      "avg"
      } else if (text_refs$prcp_depart >= prcp_quant[2]){
        "wet"
        } else (FALSE)

temp_text <- if (temp_error %in% c("both", "annual", "month")) {
  'error'
  } else if (text_refs$temp_midpt <= temp_quant[1]) {
    "cool"
    } else if (text_refs$temp_midpt > temp_quant[1] & 
               text_refs$temp_midpt < temp_quant[2]){
      "avg"
      } else if (text_refs$temp_midpt >= temp_quant[2]){
        "warm"
        } else (FALSE)
```

This document summarizes current temperature and precipitation anomalies relative to 30-year (1981-2010) averages for `r my_station$name` during the `r my_year` water year (October `r my_year - 1` through September `r my_year`).
The data used in these analyses are part of the NOAA Global Historical Climatology Network (GHCN) Cooperative Observer Network (COOP) and were downloaded from [ClimateAnalyzer.org](http://www.climateanalyzer.org/) on `r format(as.Date(lubridate::today(), format = "%Y-%m-%d"), "%d %B, %Y")` using R (ver. `r r_ver`, R Core Team, `r info$R.version$year`) and the climateAnalyzeR package (ver  `r info$otherPkgs$climateAnalyzeR$Version`, Van Scoyoc, `r lubridate::year(stringr::str_split(info$otherPkgs$climateAnalyzeR$Built, pattern = ";")[[1]][3])`).
The data used for these analyses include the daily high temperature (TMAX), daily low temperature (TMIN), and daily precipitation accumulation (PRCP). This is an automated summary and all results are provisional.

```{r Map, echo=FALSE, fig.cap="Location of weather station.", fig.height=5, message=FALSE, warning=FALSE}
# Identify location
extent <- dplyr::select(my_station, lon, lat)
print(extent)

# Expand to desired scale
extent[2, ] <- c(extent[1, 1] + 0.04, extent[1, 2] + 0.025)
extent[3, ] <- c(extent[1, 1] - 0.04, extent[1, 2] - 0.025)

# Create box to pull basemap from Google
my_box <- ggmap::make_bbox(lon = extent$lon, lat = extent$lat, f = 0.1)
# Pull basemap from Google
my_map <- ggmap::get_map(location = my_box, maptype = "terrain", source = "google", 
                  zoom = 13, force = TRUE, messaging = TRUE)
# Finish Map
my_map <- ggmap::ggmap(my_map) + 
  ggplot2::geom_point(data = my_station, ggplot2::aes(x = lon, y = lat), 
                      color = "red", size = 4) +
  shadowtext::geom_shadowtext(data = my_station, 
                              mapping = ggplot2::aes(x = lon, y = lat, 
                                                     label = name),
                                color = "black", bg.colour = "white", size = 3,
                                hjust = -0.1, vjust = -0.5) +
  ggplot2::labs(x = "Longitude", y = "Latitude")
my_map
```

\newpage
# Temperature
```{r Temp_Text, echo=FALSE, results='asis', eval=(temp_text %in% c("cool", "avg", "warm"))}
# Text is printed in PDF if `temp_text %in% c("cool", "avg", "warm")` returns TRUE
cat(
  # Sentence 1
  if (text_refs$temp_coldest == 1){
    paste0("Water year ", my_year, " was the coldest year on record for ", my_station$name, ".")
    } else if (temp_text == "cool"){
    paste0("Water year ", my_year, " was the ",  number_contraction(text_refs$temp_coldest), " coolest water year in the ", text_refs$timespan, "-year record for ", my_station$name, ".")
      } else if (temp_text == "avg"){
        paste0("Temperatures were normal for water year ", my_year, ", this water year was the ",  number_contraction(text_refs$temp_warmest), " warmest water year in the ", text_refs$timespan, "-year record for ", my_station$name, ".")
        } else if (text_refs$temp_warmest == 1){
          paste0("Water year ", my_year, " was the hottest year on record for ", my_station$name, ".")
          } else if (temp_text == "warm"){
            paste0("Water year ", my_year, " was the ",  number_contraction(text_refs$temp_warmest), " warmest water year in the ", text_refs$timespan, "-year record for ", my_station$name, ".")
            },
  
  # Sentence 2
  paste0("The average annual temperature was ", round(text_refs$temp_midpt, 2), "°F which is ", abs(round(text_refs$temp_depart, 2)), "°F ", ifelse(text_refs$temp_depart > 0, "above", "below"), " the 30-year average (", round(annual_30yr$TEMP_midpt, 2), "°F)."), 
  
  # Sentence 3
  paste0("This summary suggests that temperatures are ", ifelse(temp_lm > 0, "increasing", "decreasing"), " ", abs(round(temp_lm*10, 2)), "°F per decade (Figure 1A)."), 
  
  # Sentence 4
  if (length(tmax_exceed) == 0){
    paste0("Every monthly average TMAX was below normal in ", my_year, " (Figure 1B).")
  } else if (length(tmax_exceed) == 12){
    paste0("Every monthly average TMAX was above normal in ", my_year, " (Figure 1B).")
  } else (paste0("The monthly average TMAX was ", ifelse(length(tmax_exceed) >= 6, "above", "below"), " normal most of the year and exceeded the 30-year monthly average ", length(tmax_exceed), " times (", paste(paste(tmax_exceed[1:length(tmax_exceed)-1], collapse = ", "), tmax_exceed[length(tmax_exceed)], sep = ", and "), "; Figure 1B)."))  , 
  
  # Sentence 5
  if (length(tmin_exceed) == 0){
    paste0("Every monthly average TMAX was below normal in ", my_year, " (Figure 1B).")
  } else if (length(tmin_exceed) == 12){
    paste0("Every monthly average TMAX was above normal in ", my_year, " (Figure 1B).")
  } else (paste0("The monthly average TMIN was ", ifelse(length(tmin_exceed) >= 6, "above", "below"), " normal most of the year and exceeded the 30-year monthly average ", length(tmin_exceed), " times (",  paste(paste(tmin_exceed[1:length(tmin_exceed)-1], collapse = ", "), tmin_exceed[length(tmin_exceed)], sep = ", and "), "; Figure 1C)."))
)
```


```{r Insufficient_Temp, echo=FALSE, results='asis', eval=(temp_text == "error")}
# Text for errors in monthly and annual data sets.
if (temp_error == "both") {
  cat(
  # Sentence 1
  paste0("There are too many missing records to meaningfully summarize data from this station for water year ", my_year, "."), 

  # Sentence 2
  ("Examine annual and monthly data sets on ClimateAnalyzer.org for more information."),

  # Sentence 3
    paste0("However, this summary suggests that temperatures are ", ifelse(temp_lm > 0, "increasing", "decreasing"), " ", abs(round(temp_lm*10, 2)), "°F per decade (Figure 1A).") 
  )
}

# Text for errors in annual data set. Monthly data set is good.
if (temp_error == "annual") {
  cat(
  # Sentence 1
  paste0("There are too many missing records to meaningfully summarize the annual data from this station for water year ", my_year, "."),  

  # Sentence 2
  ("Examine the annual data set on ClimateAnalyzer.org for more information."),
  
  # Sentence 3
  paste0("However, this summary suggests that temperatures are ", ifelse(temp_lm > 0, "increasing", "decreasing"), " ", abs(round(temp_lm*10, 2)), "°F per decade (Figure 1A)."), 
  
  # Sentence 4
  if (length(tmax_exceed) == 0){
    paste0("Every monthly average TMAX was below normal in ", my_year, " (Figure 1B).")
  } else if (length(tmax_exceed) == 12){
    paste0("Every monthly average TMAX was above normal in ", my_year, " (Figure 1B).")
  } else (paste0("The monthly average TMAX was ", ifelse(length(tmax_exceed) >= 6, "above", "below"), " normal most of the year and exceeded the 30-year monthly average ", length(tmax_exceed), " times (", paste(paste(tmax_exceed[1:length(tmax_exceed)-1], collapse = ", "), tmax_exceed[length(tmax_exceed)], sep = ", and "), "; Figure 1B)."))  , 
  
  # Sentence 5
  if (length(tmin_exceed) == 0){
    paste0("Every monthly average TMAX was below normal in ", my_year, " (Figure 1B).")
  } else if (length(tmin_exceed) == 12){
    paste0("Every monthly average TMAX was above normal in ", my_year, " (Figure 1B).")
  } else (paste0("The monthly average TMIN was ", ifelse(length(tmin_exceed) >= 6, "above", "below"), " normal most of the year and exceeded the 30-year monthly average ", length(tmin_exceed), " times (",  paste(paste(tmin_exceed[1:length(tmin_exceed)-1], collapse = ", "), tmin_exceed[length(tmin_exceed)], sep = ", and "), "; Figure 1C)."))
  )
}

# Text for errors in monthly data set. Annual data set is good.
if (temp_error == "month") {
  cat(
  # Sentence 1
    paste0("There are too many missing records to meaningfully summarize the montly data from this station for water year ", my_year, "."),
    
  # Sentence 2
  ("Examine the montly data set on ClimateAnalyzer.org for more information."),
    
  # Sentence 3
  if (text_refs$temp_warmest == text_refs$timespan){
    paste0("However, water year ", my_year, " was the coldest year on record for ", my_station$name, ".")
  } else if (temp_text == "cool"){
    paste0("Water year ", my_year, " was the ",  number_contraction(text_refs$timespan - text_refs$temp_warmest), " coolest water year in the ", text_refs$timespan, "-year record for ", my_station$name, ".")
  } else if (temp_text == "avg"){
    paste0("Temperatures were normal for water year ", my_year, ", this water year was the ",  number_contraction(text_refs$temp_warmest), " warmest water year in the ", text_refs$timespan, "-year record for ", my_station$name, ".")
  } else if (text_refs$temp_warmest == 1){
    paste0("Water year ", my_year, " was the hottest year on record for ", my_station$name, ".")
  } else (
    paste0("Water year ", my_year, " was the ",  number_contraction(text_refs$temp_warmest), " warmest water year in the ", text_refs$timespan, "-year record for ", my_station$name, ".")),
  
  # Sentence 4
  paste0("The average annual temperature was ", round(text_refs$temp_midpt, 2), "°F which is ", abs(round(text_refs$temp_depart, 2)), "°F ", ifelse(text_refs$temp_depart > 0, "above", "below"), " the 30-year average (", round(annual_30yr$TEMP_midpt, 2), "°F)."), 
  
  # Sentence 5
  paste0("This summary suggests that temperatures are ", ifelse(temp_lm > 0, "increasing", "decreasing"), " ", abs(round(temp_lm*10, 2)), "°F per decade (Figure 1A).")
  )
}
```

```{r Error_Temp, echo=FALSE, results='asis', eval=(temp_text == FALSE)}
# Text is printed if temp_text == FALSE
cat("Error: temperature data could not be evaluated. Examine tabular data sets on ClimateAnalyzer.org.")
```

```{r Temp_Fig, echo=FALSE, fig.cap="Trends in average temperature.", fig.height=6.7, message=FALSE, warning=FALSE}
#-- Average Annual Temps
t1 <- annual_figure(x_var = annual_dat$year,
                    y_var = annual_dat$temp_midpt,
                    my_year = my_year,
                    normal = annual_30yr$TEMP_midpt,
                    reference_period = "1981-2010",
                    area_color = "orange",
                    line_color = "red3",
                    my_title = "A. Average Annual Temperature",
                    my_ylab = "Temperature (°F)")

#-- Average WY TMAX/TMIN
t2 <- monthly_figure(x_var = mth_depart$month_name,
                     y_var = mth_depart$tmax_depart,
                     year_group = mth_depart$water_yr,
                     y_intercept = 0,
                     my_year = my_year,
                     line_color = "red3",
                     my_title = "B. Average Monthly TMAX",
                     my_ylab = "Departure (°F)") +
  ggplot2::theme(axis.text.x = ggplot2::element_blank())

#-- TMAX/TMIN Departure
t3 <- monthly_figure(x_var = mth_depart$month_name,
                     y_var = mth_depart$tmin_depart,
                     year_group = mth_depart$water_yr,
                     y_intercept = 0,
                     my_year = my_year,
                     line_color = "red3",
                     my_title = "C. Average Monthly TMIN",
                     my_ylab = "Departure (°F)")


cowplot::plot_grid(t1, t2, t3, labels = c(), ncol = 1, align = "v",
                   vjust = 1, scale = 1)
```

\newpage
# Precipitation
```{r PRCP_Text, echo=FALSE, results='asis', eval=(prcp_text %in% c("dry", "avg", "wet"))}
cat(
  # Sentence 1
  if (text_refs$prcp_driest == 1){
    paste0("Water year ", my_year, " was the driest year on record for ", my_station$name, ".")
    } else if (prcp_text == "dry"){
      paste0("Water year ", my_year, " was the ", number_contraction(text_refs$prcp_driest), " driest on record for ", station_name, ".")
      } else if (prcp_text == "avg"){
        paste0(station_name, " received an average amount of precipitation during the ", my_year, " water year and was the ", number_contraction(text_refs$prcp_driest), " driest on record.")
        } else if (text_refs$prcp_wettest == 1){
          paste0("Water year ", my_year, " was the wettest year on record for ", my_station$name, ".")
          } else (paste0("Water year ", my_year, " was the ", number_contraction(text_refs$prcp_wettest), " wettest on record for ", station_name, ".")), 
  
  # Sentence 2
  paste0("Total accumulated precipitation was ", text_refs$prcp_wy, " inches and was ", round(abs(text_refs$prcp_wy - annual_30yr$PRCP), 2), " inches ", ifelse(text_refs$prcp_wy - annual_30yr$PRCP < 0, "below", "above")," the 30-year average (", round(annual_30yr$PRCP, 2), " inches)."), 
  # Sentence 3
  paste0("This summary suggests that precipitation is ", ifelse(prcp_lm > 0, "increasing", "decreasing"), " at a rate of ", abs(round(prcp_lm * 10, 2)), " inches per decade (Figure 2A)."), 
  
  # Sentence 4
  # TODO: write if else statement for dry, normal, & wet years
  if(prcp_text == "dry"){
    paste0(paste(paste(prcp_above[1:length(prcp_above)-1], collapse = ", "), prcp_above[length(prcp_above)], sep = ", and "), " received above average precipitation (Figure 2B), but were not enough to compensate for the ", length(prcp_below), " months that were below average (",  paste(paste(prcp_below[1:length(prcp_below)-1], collapse = ", "), prcp_below[length(prcp_below)], sep = ", and "), "; Figure 2C).")
  } else if (prcp_text == "avg"){
    paste0(paste(paste(prcp_above[1:length(prcp_above)-1], collapse = ", "), prcp_above[length(prcp_above)], sep = ", and "), " received above average precipitation (Figure 2B) and ",  paste(paste(prcp_below[1:length(prcp_below)-1], collapse = ", "), prcp_below[length(prcp_below)], sep = ", and "), "received below average precipitation (Figure 2C).")
  } else if (prcp_text == "wet"){
    paste0(paste(paste(prcp_above[1:length(prcp_above)-1], collapse = ", "), prcp_above[length(prcp_above)], sep = ", and "), " received above average precipitation (Figure 2B) and ",  paste(paste(prcp_below[1:length(prcp_below)-1], collapse = ", "), prcp_below[length(prcp_below)], sep = ", and "), "received below average precipitation (Figure 2C).")
  }
)
```

```{r Insufficient_PRCP, echo=FALSE, results='asis', eval=(prcp_text == "error")}
# Text for errors in monthly and annual data sets.
if (prcp_error == "both"){
  cat(
  # Sentence 1
  paste0("There are too many missing records to meaningfully summarize data from this station for water year ", my_year, ";"), 

  # Sentence 2
  ("Examine annual and monthly data sets on ClimateAnalyzer.org for more information."),

  # Sentence 3
  paste0("However, this summary suggests that precipitation is ", ifelse(prcp_lm > 0, "increasing", "decreasing"), " ", abs(round(prcp_lm*10, 2)), " inches per decade (Figure 1A).")
  )}

# Text for errors in annual data set. Monthly data set is good.
if (prcp_error == "annual") {
  cat(
  # Sentence 1
  paste0("There are too many missing records to meaningfully summarize the annual data from this station for water year ", my_year, "."),  

  # Sentence 2
  ("Examine the annual data set on ClimateAnalyzer.org for more information."),
  
  # Sentence 3
  paste0("However, this summary suggests that precipitation is ", ifelse(prcp_lm > 0, "increasing", "decreasing"), " at a rate of ", abs(round(prcp_lm * 10, 2)), " inches per decade (Figure 2A)."), 
  
  # Sentence 4
  # TODO: write if else statement for dry, normal, & wet years
  paste0(paste(paste(prcp_above[1:length(prcp_above)-1], collapse = ", "), prcp_above[length(prcp_above)], sep = ", and "), " received above average precipitation (Figure 2B), but were not enough to compensate for the ", length(prcp_below), " months that were below average (",  paste(paste(prcp_below[1:length(prcp_below)-1], collapse = ", "), prcp_below[length(prcp_below)], sep = ", and "), "; Figure 2C).")
  )}

# Text for errors in monthly data set. Annual data set is good.
if (prcp_error == "month") {
  cat(
  # Sentence 1
    paste0("There are too many missing records to meaningfully summarize the montly data from this station for water year ", my_year, "."),
    
  # Sentence 2
  ("Examine the montly data set on ClimateAnalyzer.org for more information."),
    
  # Sentence 3
  if (text_refs$prcp_driest == 1){
    paste0("Water year ", my_year, " was the driest year on record for ", my_station$name, ".")
  } else if (prcp_text == "dry"){
    paste0("Water year ", my_year, " was the ", number_contraction(text_refs$prcp_driest), " driest on record for ", station_name, ".")
  } else if (prcp_text == "avg"){
    paste0(station_name, " received an average amount of precipitation during the ", my_year, " water year and was the ", number_contraction(text_refs$prcp_driest), " driest on record.")
  } else if (text_refs$prcp_driest == text_refs$timespan){
    paste0("Water year ", my_year, " was the wettest year on record for ", my_station$name, ".")
  } else (paste0("Water year ", my_year, " was the ", number_contraction(text_refs$prcp_driest), " wettest on record for ", station_name, ".")), 
  
  # Sentence 4
  paste0("Total accumulated precipitation was ", text_refs$prcp_wy, " inches and was ", round(abs(text_refs$prcp_wy - annual_30yr$PRCP), 2), " inches ", ifelse(text_refs$prcp_wy - annual_30yr$PRCP < 0, "below", "above")," the 30-year average (", round(annual_30yr$PRCP, 2), " inches)."), 
  
  # Sentence 5
  paste0("This summary suggests that precipitation is ", ifelse(prcp_lm > 0, "increasing", "decreasing"), " at a rate of ", abs(round(prcp_lm * 10, 2)), " inches per decade (Figure 2A).")
  )}
```

```{r Error_PRCP, echo=FALSE, results='asis', eval=(prcp_text == FALSE)}
# Text is printed if prcp_text == FALSE
cat("Error: precipitation data could not be evaluated. Examine tabular data set on ClimateAnalyzer.org.")
```

```{r PRCP_Fig, echo=FALSE, fig.cap="Trends in  precipitation.", fig.height=6.7, message=FALSE, warning=FALSE}
#-- Water year precipitation totals
p1 <- annual_figure(x_var = annual_dat$year,
                    y_var = annual_dat$prcp_wy,
                    my_year = my_year,
                    normal = annual_30yr$PRCP,
                    reference_period = "1981-2010",
                    area_color = "green3",
                    line_color = "darkgreen",
                    my_title = "A. Water Year Precipitation Totals",
                    my_ylab = "Precipitation (inches)")

#-- Monthly precipitation totals
p2 <- monthly_figure(x_var = mth_depart$month_name,
                     y_var = mth_depart$prcp_pctavg,
                     year_group = mth_depart$water_yr,
                     y_intercept = 100,
                     my_year = my_year,
                     line_color = "darkgreen",
                     my_title = "B. Monthly Departure Realtive to the Historic Record",
                     my_ylab = "Percent Average (%)") +
  ggplot2::theme(axis.text.x = ggplot2::element_blank())

#-- Water year accumulation
p3 <- monthly_figure(x_var = mth_depart$month_name,
                     y_var = mth_depart$prcp_accum_depart,
                     year_group = mth_depart$water_yr,
                     y_intercept = 0,
                     my_year = my_year,
                     line_color = "darkgreen",
                     my_title = "C. Accumulated Departure Realtive to the Historic Record",
                     my_ylab = "Departure (inches)")

# Using cowplot to arrange figures
cowplot::plot_grid(p1, p2, p3, labels = c(""), ncol = 1, align = "v")
```
