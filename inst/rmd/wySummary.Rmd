---
title: |
  | `r station_name`
  | `r paste("Water Year", year, "Climate Summary", sep = " ")`
author: "Matthew Van Scoyoc"
date: "`r format(as.Date(Sys.Date(), format = '%Y-%m-%d'), '%B %d, %Y')`"
output:
  pdf_document: 
    fig_caption: yes
    latex_engine: xelatex
editor_options:
  chunk_output_type: console
mainfont: Arial
urlcolor: blue
---
\raggedright
```{r Setup, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
#-- Packages
# install.packages(c("cowplot", "devtools", "grid", "gridExtra", "knitr", 
#                    "lubridate", "tidyverse", "shadowtext"))
# devtools::install_github("scoyoc/climateAnalyzeR")
library("climateAnalyzeR") # Import data from ClimateAnalyzer.org
library("cowplot") # Streamlining for ggplot2
library("grid")
library("gridExtra")
library("knitr") # Makes nice output
library("lubridate") # Makes dating easier
library("tidyverse") # Data manipulation
library("shadowtext") # Figure detailing

#-- Functions
# Number contraction ---
# Prints the appropriate number contraction for a given number.
number_contraction <- function(x) {
  if (is.na(x)){
    y = "[insofficient data]"
  } else if  (x == 1) {
    y = paste0(x, "st")
  } else if (x == 2) {
    y = paste0(x, "nd")
  } else if (x == 3) {
    y = paste0(x, "rd")
  } else {
    y = paste0(x, "th")
  }
  return(y)
}

# Visitor Center ---
# Produces text appropriate for the visitor center.
visitor_center <- function(my_park) {
  if (my_park == "CANY") {
    (y <- "Co-op weather stations at the ISKY, MAZE, and NEED visitor centers by NPS personnel")
  } else if (my_park == "Moab") {
    (y <- "Co-op weather station in downtown Moab")
  } else {
    (y <- "Co-op weather station at the visitor center by NPS personnel")
  }
  return(y)
}

#-- Figures
# Standardized line graph using geom_area()
area_figure <- function(dat, # Data to plot
                        x_var, # The vector for the x-variable
                        y_var, # The vector for the y-variable
                        area_color, # The color of the area
                        ref_dat,# 30-year reference period data
                        line_color, # Color of line and points
                        lab_dat, # Data to map labels
                        lab_y, # Label location on y-axis
                        my_title, # The title of the plot
                        my_ylab){ # Title of y-axis
  gg <- ggplot(dat, aes(x = x_var, y = y_var)) +
    geom_area(aes(x = x_var, y = y_var),
              stat = "identity", fill = area_color, alpha = 0.5, na.rm = TRUE) +
    geom_hline(aes(yintercept = ref_dat),
               linetype = "dashed", size = 0.5, color = "black") +
    geom_line(stat = "identity", color = line_color, size = 1) +
    geom_point(stat = "identity", color = line_color, size = 2) +
    geom_smooth(method = "lm", se = FALSE, color = "blue") +
    geom_shadowtext(data = lab_dat, color = "black", bg.colour = "white",
                    mapping = aes(x = -Inf, y = lab_y, label = Label),
                    size = 3, hjust = -0.1, vjust = -0.5) +
    coord_cartesian(xlim = c(min(dat$Year), max(dat$Year)), 
                    ylim = c(floor(min(y_var, na.rm = T)), 
                             ceiling(max(y_var, na.rm = T)))) +
    labs(title = my_title, y = my_ylab) +
    my_theme
  return(gg)
}

# Standardized line graph grouped by year
line_figure <- function(dat, # Data to plot
                        x_var, # The vector for the x-variable
                        y_var, # The vector for the y-variable
                        my_yintercept, # The y-intercept for the reference line
                        wy_dat, # Filtered data for the specific water year
                        wy_xvar, # Filtered x-variable for the water year
                        wy_yvar, # Filtered y-variable for the water year
                        line_color, # Color of line and points
                        lab_dat = park_unit, # Data to map labels
                        my_title, # The title of the plot
                        my_ylab){ # Title of y-axis
  # Create figure
  gg = ggplot(dat, aes(x = x_var, y = y_var, group = waterYr)) +
    geom_line(stat = "identity", color = "gray") +
    geom_hline(aes(yintercept = my_yintercept), linetype = "dashed", size = 0.5,
               color = "black") +
    geom_line(data = wy_dat, aes(x = wy_xvar, y = wy_yvar), 
              stat = "identity", color = line_color, size = 1) +
    geom_point(data = wy_dat, aes(x = wy_xvar, y = wy_yvar), 
               stat = "identity", color = line_color, size = 2) +
    geom_shadowtext(data = lab_dat, 
                    mapping = aes(x = -Inf, y = Inf, label = waterYr),
                    color = line_color, bg.colour = "white", hjust = -1.5, 
                    vjust = 1.5, fontface = "bold") +
    geom_shadowtext(data = lab_dat, 
                    mapping = aes(x = Inf, y = Inf, label = label), 
                    color = "gray40", bg.colour = "white", hjust = 1.5, 
                    vjust = 1.5) +
    labs(title = my_title, y = my_ylab) +
    my_theme
  return(gg)
}

# ggplot theme settings
my_theme <- theme_bw() +
  theme(strip.background = element_rect(fill = "white"),
        strip.text = element_text(hjust = 0.1),
        axis.title.x = element_blank())

#-- Session information (for text)
info <- sessionInfo()
r_ver <- paste(info$R.version$major, info$R.version$minor, sep=".")
```

```{r Data, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
#-- Set desired park unit, water year, and month
# These are parameters hashed our as they are set in renderSummaries.Rmd.
# my_park <- "ARCH"
# year = 2020

# Create a data frame of months.
month_df <- data.frame(Month = 1:12, 
                       waterMonth = c(4:12, 1:3),
                       mthName = factor(month.abb, 
                                        levels = c(month.abb[10:12], 
                                                   month.abb[1:9])), 
                       season = c("Wi", "Wi", "Sp", "Sp", "Sp", "Su", "Su", 
                                  "Su", "Fa", "Fa", "Fa", "Wi"))

# Station Metadata
park_unit <- filter(readr::read_csv("stations.csv"), parkCode == my_park) %>%
  mutate(label = paste(firstYear, year, sep = "-"),
         waterYr = year)

#-- Annual Data ---- 
annual_dat  <- import_data("annual_wx", park_unit$stationid, 
                           park_unit$firstYear, year, 
                           remove_missing = TRUE) %>%
  filter(Year <= year) %>%
  select(Year | contains("wy")) %>%
  mutate(TEMP_midpt = ifelse(is.na(TMAX_wy) | is.na(TMIN_wy), NA, 
                             ((TMAX_wy - TMIN_wy) / 2) + TMIN_wy), 
         PRCP_driest = min_rank(PRCP_wy), 
         TEMP_mid_warmest = min_rank(-TEMP_midpt), 
         TMAX_warmest = min_rank(-TMAX_wy),
         TMIN_warmest = min_rank(-TMIN_wy))
# Calculate 30-year averages
annual_30yr <- annual_dat %>%
  filter(Year >= 1981 & Year <= 2010) %>%
  summarise(PRCP = mean(PRCP_wy, na.rm = T),
            TEMP_midpt = mean(TEMP_midpt, na.rm = T), 
            TMAX = mean(TMAX_wy, na.rm = T),
            TMIN = mean(TMIN_wy, na.rm = T))
# Calculate annual departure
annual_dat <- annual_dat %>%
  mutate(PRCP_depart = PRCP_wy - annual_30yr$PRCP,
         TEMP_mid_depart = TEMP_midpt - annual_30yr$TEMP_midpt,
         TMAX_depart = TMAX_wy - annual_30yr$TMAX, 
         TMIN_depart = TMIN_wy - annual_30yr$TMIN)

#-- Monthly Data ----
# Monthly weather data
mth_dat <- import_data("monthly_wx", park_unit$stationid, park_unit$firstYear, 
                        year) %>%
  left_join(month_df) %>%
  mutate(waterYr = ifelse(Month >= 10, Year +1, Year)) %>%
  filter(waterYr <= year) %>%
  arrange(waterYr, waterMonth) %>%
  group_by(waterYr) %>%
  mutate(PRCP_accum = cumsum(PRCP)) %>%
    mutate(TEMP_midpt = ifelse(is.na(TMAX) | is.na(TMIN), NA, 
                             ((TMAX - TMIN) / 2) + TMIN)) %>%
  group_by(waterMonth) %>%
  mutate(PRCP_driest = min_rank(PRCP), 
         TEMP_mid_warmest = min_rank(-TEMP_midpt), 
         TMAX_warmest = min_rank(-TMAX),
         TMIN_warmest = min_rank(-TMIN))
# Calculate 30-year monthly averages
mth_30yr <-  mth_dat %>%
  filter(waterYr >= 1981 & waterYr <= 2010) %>%
  group_by(mthName) %>%
  summarise(PRCP_30yr = mean(PRCP, na.rm = T),
            PRCP_accum_30yr = mean(PRCP_accum, na.rm = T),
            TEMP_midpt_30yr = mean(TEMP_midpt, na.rm = T), 
            TMAX_30yr = mean(TMAX, na.rm = T),
            TMIN_30yr = mean(TMIN, na.rm = T))

# Monthly departure
mth_depart <- import_data("departure", park_unit$stationid, 
                          park_unit$firstYear, year, 
                          norm_per = "1981-2010") %>%
  left_join(month_df) %>%
  mutate(waterYr = ifelse(Month >= 10, Year +1, Year)) %>%
  filter(waterYr <= year) %>%
  left_join(left_join(mth_dat, mth_30yr) %>%
              ungroup() %>%
              mutate(PRCP_accum_depart = PRCP_accum - PRCP_accum_30yr) %>%
              select(Year, mthName, PRCP_accum_depart))

#-- Small subsets for text
# Filter data sets by year
# wy_annual <- filter(annual_dat, Year == year)
# wy_mth <- filter(mth_dat, waterYr == year)
# wy_depart <- filter(mth_depart, waterYr == year)
tmax_exceed <- filter(mth_depart, waterYr == year & TMAX_depart > 0)
tmin_exceed <- filter(mth_depart, waterYr == year & TMIN_depart > 0)
prcp_above <- filter(mth_depart, waterYr == year & PRCP_pctavg > 100)
prcp_below <- filter(mth_depart, waterYr == year & PRCP_pctavg < 100)
text_refs <- park_unit %>%
  bind_cols(filter(annual_dat, Year == year)) %>%
  mutate(timespan = year - firstYear)

#-- Model annual trends
prcp_lm <- summary(lm(PRCP_wy ~ Year, data = annual_dat))$coefficients[2, 1]
temp_lm <- summary(lm(TEMP_midpt ~ Year, data = annual_dat))$coefficients[2, 1]
```
This document summarizes current temperature and precipitation anomalies 
relative to 30-year (1981-2010) averages for 
`r park_unit$unitName` (`r my_park`) during the 
`r year` water year (October `r year-1` through September `r year`). 
The data for these analyses were collected at the `r visitor_center(my_park)` 
and  downloaded from [ClimateAnalyzer.org](http://www.climateanalyzer.org/) 
on 
`r format(as.Date(lubridate::today(), format = "%Y-%m-%d"), "%d %B, %Y")` 
using R (ver. `r r_ver`, R Core Team, 2020) and the climateAnalyzeR package (ver 
`r info$otherPkgs$climateAnalyzeR$Version`, Van Scoyoc, 2021). 
The data used for these analyses include the daily high temperature (TMAX), 
daily low temperature (TMIN), and daily precipitation accumulation (PRCP). This 
is an automated summary and all results are provisional.
  
# Temperature
Water year `r year` was the 
`r number_contraction(text_refs$TEMP_mid_warmest)` warmest water year in the 
`r text_refs$timespan`-year record for 
`r my_park` (`r text_refs$firstYear` to `r year`). 
The average annual temperature was 
`r round(text_refs$TEMP_midpt, 2)`, which is
`r abs(round(text_refs$TEMP_mid_depart, 2))`°F 
`r ifelse(text_refs$TEMP_mid_depart > 0, "above", "below")` the 30-year average 
(`r round(annual_30yr$TEMP_midpt, 2)`°F). 
This summary suggests that temperatures are 
`r ifelse(temp_lm > 0, "increasing", "decreasing")` 
`r abs(round(temp_lm*10, 2))`°F per decade (Figure 1A).
The monthly average TMAX was 
`r ifelse(nrow(tmax_exceed) >= 6, "above", "below")` normal most of the year and 
exceeded the 30-year monthly average 
`r nrow(tmax_exceed)` times (
`r paste(paste(tmax_exceed$mthName[1:nrow(tmax_exceed)-1], collapse = ", "), tmax_exceed$mthName[nrow(tmax_exceed)], sep = ", and ")`
; Figure 1B).
The monthly average TMIN was 
`r ifelse(nrow(tmin_exceed) >= 6, "above", "below")` normal most of the year and 
exceeded the 30-year monthly average 
`r nrow(tmin_exceed)` times 
(`r paste(paste(tmin_exceed$mthName[1:nrow(tmin_exceed)-1], collapse = ", "), tmin_exceed$mthName[nrow(tmin_exceed)], sep = ", and ")`
; Figure 1C).

# Precipitation
Water year `r year` was the 
`r number_contraction(text_refs$PRCP_driest)` driest on record for `r my_park`. 
Total accumulated precipitation was
`r text_refs$PRCP_wy` inches and was 
`r round(abs(text_refs$PRCP_wy - annual_30yr$PRCP), 2)` inches 
`r ifelse(text_refs$PRCP_wy - annual_30yr$PRCP < 0, "below", "above")` 
the 30-year average 
(`r round(annual_30yr$PRCP, 2)` inches). This summary suggests that 
precipitation is 
`r ifelse(prcp_lm > 0, "increasing", "decreasing")` at a rate of 
`r abs(round(prcp_lm * 10, 2))` inches per decade (Figure 2A).
`r paste(paste(prcp_above$mthName[1:nrow(prcp_above)-1], collapse = ", "), prcp_above$mthName[nrow(prcp_above)], sep = ", and ")` 
received above average precipitation (Figure 2B), but were not enough to 
compensate for the 
`r nrow(prcp_below)` months that were below average 
(`r paste(paste(prcp_below$mthName[1:nrow(prcp_below)-1], collapse = ", "), prcp_below$mthName[nrow(prcp_below)], sep = ", and ")`
; Figure 2C).

\newpage
# Figures
```{r Fig1, echo=FALSE, fig.cap="Trends in average temperature.", fig.height=6.7, message=FALSE, warning=FALSE}
#-- Average WY Temps
# Labels
t1_lab <- annual_30yr %>%
  mutate(Label = paste0("1981-2010 Avg: ", round(annual_30yr$TEMP_midpt, 1), "°F"))
# Figure
t1a <- area_figure(dat = annual_dat, # Data to plot
                   x_var = annual_dat$Year, # The vector for the x-variable
                   y_var = annual_dat$TEMP_midpt, # The vector for the y-variable
                   area_color = "orange", # The color of the area
                   ref_dat = annual_30yr$TEMP_midpt, # 30-year reference period data
                   line_color = "red3", # Color of line and points
                   lab_dat = t1_lab, # Data to map labels
                   lab_y = t1_lab$TEMP_midpt, # Label location on y-axis
                   my_title = "A. Average Annual Temperature", # The title of the plot
                   my_ylab = "Temperature (°F)")

#-- Average WY TMAX/TMIN
# Prepare data
t_dat <- mth_depart %>%
  select(waterYr, mthName, TMAX_depart, TMIN_depart) %>%
  rename("TMAX" = TMAX_depart, "TMIN" = TMIN_depart) %>%
  gather(key = "Element", value = "Departure", TMAX:TMIN)

#-- TMAX
t1b <- line_figure(dat = filter(t_dat, Element == "TMAX"), 
                   x_var = filter(t_dat, Element == "TMAX")$mthName, 
                   y_var = filter(t_dat, Element == "TMAX")$Departure, 
                   my_yintercept = 0, 
                   wy_dat = filter(t_dat, Element == "TMAX" & 
                                     waterYr == year),
                   wy_xvar = filter(t_dat, Element == "TMAX" & 
                                      waterYr == year)$mthName,
                   wy_yvar = filter(t_dat, Element == "TMAX" & 
                                      waterYr == year)$Departure,
                   line_color = "red3", 
                   my_title = "B. Average Monthly TMAX", 
                   my_ylab = "Departure (°F)") +
  theme(axis.text.x = element_blank())

#-- TMIN
t1c <- line_figure(dat = filter(t_dat, Element == "TMIN"), 
                   x_var = filter(t_dat, Element == "TMIN")$mthName, 
                   y_var = filter(t_dat, Element == "TMIN")$Departure, 
                   my_yintercept = 0, 
                   wy_dat = filter(t_dat, Element == "TMIN" & 
                                     waterYr == year),
                   wy_xvar = filter(t_dat, Element == "TMIN" & 
                                      waterYr == year)$mthName,
                   wy_yvar = filter(t_dat, Element == "TMIN" & 
                                      waterYr == year)$Departure,
                   line_color = "red3", 
                   my_title = "C. Average Monthly TMIN", 
                   my_ylab = "Departure (°F)")

plot_grid(t1a, t1b, t1c, labels = c(), ncol = 1, align = "v", vjust = 1, 
                scale = 1)
```

```{r Fig2, echo=FALSE, fig.cap="Trends in  precipitation.", fig.height=6.7, message=FALSE, warning=FALSE}
#-- Water year precipitation totals
# Labels
p1_lab <- annual_30yr %>%
  mutate(Label = paste0("1981-2010 Avg: ", round(annual_30yr$PRCP, 1), " in"))
# Figure
p1 <- area_figure(dat = annual_dat, # Dataframe to plot
                  x_var = annual_dat$Year, # The vector for the x-variable
                  y_var = annual_dat$PRCP_wy, # The vector of the y-variable
                  area_color = "darkgreen", # The color of the area
                  ref_dat = annual_30yr$PRCP,# 30-year reference period dataframe
                  line_color = "darkgreen", # Color of line and points
                  lab_dat = p1_lab, # Dataframe to map labels
                  lab_y = p1_lab$PRCP, # Label location on y-axis
                  my_title = "A. Water Year Precipitation Totals", # The title of the plot
                  my_ylab = "Precipitation (in)")

#-- Monthly precipitation totals
# Prepare data
p_mth <- mth_depart %>%
  select(waterYr, mthName, PRCP_pctavg) %>%
  rename("PRCP" = PRCP_pctavg) %>%
  gather(key = "Element", value = "PctAvg", PRCP)
# Figure
p2 <- line_figure(dat = p_mth, 
                  x_var = p_mth$mthName, 
                  y_var = p_mth$PctAvg, 
                  my_yintercept = 100,
                  wy_dat = filter(p_mth, waterYr == year),
                  wy_xvar = filter(p_mth, waterYr == year)$mthName,
                  wy_yvar = filter(p_mth, waterYr == year)$PctAvg,
                  line_color = "darkgreen", 
                  my_title = "B. Montly Departure Realtive to the Historic Record", 
                  my_ylab = "Percent Average") +
  theme(axis.text.x = element_blank())

#-- Water year accumulation
# Prepare Data
p_acc <- mth_depart %>%
  ungroup() %>%
  select(waterYr, mthName, PRCP_accum_depart) %>%
  rename("PRCP" = PRCP_accum_depart) %>%
  gather(key = "Element", value = "Accumulation", PRCP)

# Figure
p3 <- line_figure(dat = p_acc, # Data to plot
                  x_var = p_acc$mthName, # The vector for the x-variable
                  y_var = p_acc$Accumulation, # The vector for the y-variable
                  my_yintercept = 0, # The y-intercept for the reference line
                  wy_dat = filter(p_acc, waterYr == year), 
                  wy_xvar= filter(p_acc, waterYr == year)$mthName, 
                  wy_yvar = filter(p_acc, waterYr == year)$Accumulation, 
                  line_color = "darkgreen", # Color of line and points
                  lab_dat = park_unit, # Data to map labels
                  my_title = "C. Accumulated Departure Realtive to the Historic Record", # The title of the plot
                  my_ylab = "Departure (in)") # Title of y-axis

# Using cowplot to arrange figures
plot_grid(p1, p2, p3, labels = c(""), ncol = 1, align = "v")
```
